name: Deploy Mobile and API

on:
  push:
    branches: [prod]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üìÇ Checkout repository
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: üèóÔ∏è Install dependencies
        run: npm ci

      # ------------------------------------------------------
      # Deploy Mobile app to EAS Hosting (web)
      # ------------------------------------------------------
      - name: üì¶ Build api-client package and fix mobile app dependencies
        run: npm run build

      - name: üì¶ Export for web
        run: npx -w apps/mobile expo export --platform web
        env:
          EXPO_PUBLIC_API_URL: ${{ secrets.API_URL }}
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.SUPABASE_PUBLISHABLE_KEY }}
          EXPO_PUBLIC_GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}

      - name: üîß Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          packager: npm
          token: ${{ secrets.EAS_TOKEN }}

      - name: üöÄ Deploy to EAS Hosting
        working-directory: apps/mobile
        run: eas deploy --prod

      # ------------------------------------------------------
      # Deploy API to Cloudflare Workers and Update Supabase
      # ------------------------------------------------------
      - name: üì¶ Bundle Hono API as a serverless function
        run: npm -w apps/api run build:edge

      - name: üîë Push secrets to Cloudflare
        run: |
          echo "$SUPABASE_URL" | npx -w apps/api wrangler secret put SUPABASE_URL --config wrangler.toml
          echo "$SUPABASE_SERVICE_ROLE_KEY" | npx -w apps/api wrangler secret put SUPABASE_SERVICE_ROLE_KEY --config wrangler.toml
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: üöÄ Publish to Cloudflare Workers
        run: npx -w apps/api wrangler deploy --config wrangler.toml
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
